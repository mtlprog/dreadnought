# Фронтенд-архитектура курсовой платформы Oghma

Эта документация описывает детальную архитектуру фронтенда, паттерны и ключевые компоненты платформы. Документация создана для возможности полного воспроизведения функциональности в будущем.

## Оглавление
1. [Технологический стек](#технологический-стек)
2. [Страница списка курсов (UI/UX)](#страница-списка-курсов-uiux)
3. [Страница курса (UI/UX)](#страница-курса-uiux)
4. [Архитектура страницы курса](#архитектура-страницы-курса)
5. [Система навигации](#система-навигации)
6. [Система прогресса](#система-прогресса)
7. [Обработка Markdown](#обработка-markdown)
8. [Интернационализация](#интернационализация)
9. [UI/UX паттерны](#uiux-паттерны)
10. [Оптимизации производительности](#оптимизации-производительности)

---

## Технологический стек

### Core Technologies
- **Next.js 15** с App Router (RSC + Client Components)
- **React 18** с hooks
- **TypeScript** строгая типизация
- **Tailwind CSS** для стилизации
- **shadcn/ui** - библиотека UI компонентов

### Ключевые библиотеки
- **next-intl** - интернационализация (EN/RU)
- **next-themes** - переключение светлой/темной темы
- **lucide-react** - иконки
- **sonner** - toast уведомления
- **unified/remark/rehype** - обработка Markdown

### Паттерны
- Client Components помечены `'use client'`
- Server Components по умолчанию (RSC)
- Progressive Enhancement
- Mobile-First responsive design

---

## Страница списка курсов (UI/UX)

Этот раздел описывает UI/UX логику страницы списка доступных курсов без технических деталей - чтобы можно было воспроизвести тот же UX в любом другом проекте.

### Общая структура страницы

**URL**: `/[locale]/courses` (например `/ru/courses` или `/en/courses`)

**Layout**:
```
┌─────────────────────────────────────────┐
│          Header (навигация)             │
├─────────────────────────────────────────┤
│                                         │
│  ┌───────────────────────────────────┐ │
│  │   Заголовок: "Доступные курсы"    │ │
│  │   Подзаголовок: "Продолжите..."   │ │
│  └───────────────────────────────────┘ │
│                                         │
│  ┌─────────────┐  ┌─────────────┐     │
│  │  Карточка   │  │  Карточка   │     │
│  │  курса 1    │  │  курса 2    │     │
│  └─────────────┘  └─────────────┘     │
│                                         │
│  ┌─────────────┐  ┌─────────────┐     │
│  │  Карточка   │  │  Карточка   │     │
│  │  курса 3    │  │  курса 4    │     │
│  └─────────────┘  └─────────────┘     │
│                                         │
└─────────────────────────────────────────┘
```

### 1. Заголовок страницы

**Визуальная иерархия**:
1. **Главный заголовок** (h1, крупный, bold):
   - Текст: "Доступные курсы" (или перевод на другой язык)
   - Размер: крупный, привлекает внимание
   - Позиция: в верхней части контента

2. **Подзаголовок** (paragraph, обычный размер):
   - Текст: "Продолжите своё обучение" (или аналогичный мотивационный текст)
   - Цвет: приглушенный (вторичный текст)
   - Позиция: сразу под заголовком

**Отступы**:
- Большой отступ снизу от заголовков до сетки карточек (визуальное разделение)
- Средний отступ между главным заголовком и подзаголовком

---

### 2. Сетка карточек курсов

**Layout паттерн**:
- **Desktop**: 2 колонки (или больше при ширине экрана)
- **Tablet**: 2 колонки
- **Mobile**: 1 колонка (карточки на всю ширину)

**Отступы между карточками**:
- Горизонтальный gap: средний
- Вертикальный gap: средний
- Все карточки одинаковой высоты в ряду

---

### 3. Структура карточки курса

Каждая карточка курса состоит из **трех визуальных зон**:

```
┌─────────────────────────────────────┐
│                                     │
│  [1] Информация о курсе             │
│      - Название                     │
│      - Описание                     │
│                                     │
├─────────────────────────────────────┤
│                                     │
│  [2] Блок прогресса                 │
│      - "Прогресс: X/Y глав"         │
│      - Progress bar                 │
│                                     │
├─────────────────────────────────────┤
│                                     │
│  [3] Кнопка действия                │
│      [ Начать курс ]                │
│                                     │
└─────────────────────────────────────┘
```

#### Зона 1: Информация о курсе

**Название курса** (heading h3):
- Размер: средний-крупный, читаемый
- Стиль: полужирный (font-medium или font-semibold)
- Цвет: основной текст (foreground)
- Позиция: вверху карточки
- Пример: "Introduction to Panarchy"

**Описание курса** (paragraph):
- Размер: обычный или чуть меньше
- Стиль: обычный weight
- Цвет: приглушенный (secondary/muted text)
- Длина: 1-2 строки, краткое описание
- Позиция: сразу под названием
- Пример: "Learn the fundamentals of panarchy theory and its applications."

**Отступы**:
- Между названием и описанием: малый
- Отступ снизу от описания до блока прогресса: средний-большой

#### Зона 2: Блок прогресса

**Визуальная структура**:
```
Прогресс    0/3 глав
━━━━━━━━━━━━━━━━░░░░    (progress bar)
```

**Текстовая строка** (над progress bar):
- Левая часть: "Прогресс" (label, приглушенный цвет)
- Правая часть: "0/3 глав" или "2/5 глав" (значение, более контрастный цвет)
- Layout: flex с `justify-between` (крайние позиции)
- Размер текста: маленький (small)

**Progress Bar** (горизонтальная полоса):
- Высота: тонкая (примерно 6-8px)
- Ширина: на всю ширину блока
- Фон: приглушенный серый (unfilled state)
- Заполнение: акцентный цвет (primary color)
- Скругление углов: небольшое (rounded)
- Анимация: плавное заполнение при изменении прогресса

**Отступы**:
- Между текстовой строкой и progress bar: малый
- Отступ снизу от progress bar: средний

#### Зона 3: Кнопка действия

**Кнопка "Начать курс"**:
- Размер: полная ширина карточки (width: 100%)
- Высота: достаточная для touch-friendly взаимодействия (min 44px)
- Стиль: primary button (акцентный фон, контрастный текст)
- Текст: "Начать курс" (или "Continue" если есть прогресс)
- Позиция: внизу карточки

**Состояния кнопки**:
1. **Default** (покой):
   - Фон: акцентный цвет (primary)
   - Текст: контрастный (обычно белый)
   - Border: нет или тонкий

2. **Hover** (наведение):
   - Фон: чуть темнее или светлее (зависит от темы)
   - Тень: появляется или увеличивается
   - Cursor: pointer

3. **Active** (нажатие):
   - Scale: немного уменьшается (scale-[0.98])
   - Визуальная обратная связь: мгновенная

4. **Loading** (во время перехода):
   - Опционально: спиннер или изменение текста
   - Disabled state: нельзя нажать повторно

---

### 4. Визуальный дизайн карточки

**Фон и границы**:
- Фон карточки: background color (светлый в light mode, темный в dark mode)
- Border: тонкий, приглушенный цвет (border-muted)
- Скругление углов: среднее (rounded-lg)
- Padding внутри карточки: средний-большой (равномерный со всех сторон)

**Тени и elevation**:
- Default: легкая тень (для отделения от фона)
- Hover: увеличенная тень (карточка "приподнимается")
- Transition: плавная анимация тени при hover

**Состояния**:
1. **Default**: обычный вид
2. **Hover**: увеличенная тень, возможно легкое изменение границы
3. **Focus** (keyboard navigation): видимая focus outline для accessibility

---

### 5. UX логика взаимодействия

#### Клик по кнопке "Начать курс"

**Сценарий 1: Пользователь НЕ начинал курс**
1. Клик по кнопке "Начать курс"
2. Отправляется запрос для получения первой страницы курса
3. Происходит навигация на: `/[locale]/courses/[courseSlug]/[chapterIdx]/[pageSlug]`
4. Пример: `/ru/courses/intro-to-panarchy/1/welcome`

**Сценарий 2: Пользователь УЖЕ начал курс (есть прогресс)**
1. Клик по кнопке "Начать курс" (текст может быть "Продолжить")
2. Отправляется запрос для получения первой НЕзавершенной страницы
3. Происходит навигация на эту страницу
4. Пример: если пользователь завершил страницы 1-3, переход на страницу 4

**Fallback логика**:
- Если API не отвечает или ошибка → переход на жестко закодированную первую страницу
- Гарантируется, что пользователь всегда сможет начать курс

**Визуальная обратная связь**:
- Во время загрузки: кнопка может показывать loading state
- При успешной навигации: переход происходит плавно

---

### 6. Информационная архитектура

**Что показывает прогресс**:
- **Числитель (0, 1, 2...)**: количество ЗАВЕРШЕННЫХ глав
- **Знаменатель (3, 5...)**: общее количество глав в курсе
- **Progress bar**: визуальное представление процента завершения

**Формула прогресса**:
```
процент = (завершенные главы / всего глав) * 100
```

**Примеры**:
- `0/3 глав` + progress bar 0% → курс не начат
- `1/3 глав` + progress bar 33% → одна глава завершена
- `3/3 глав` + progress bar 100% → курс завершен

---

### 7. Адаптивность (Responsive)

**Desktop (широкие экраны)**:
- Сетка: 2-3 колонки
- Карточки: фиксированная ширина с gap между ними
- Hover эффекты: активны

**Tablet (средние экраны)**:
- Сетка: 2 колонки
- Карточки: адаптируются к ширине контейнера
- Hover эффекты: активны

**Mobile (узкие экраны)**:
- Сетка: 1 колонка
- Карточки: на всю ширину экрана (с padding по бокам)
- Touch-friendly кнопки: минимум 44px высотой
- Hover эффекты: заменены на touch states

---

### 8. Цветовая схема и контрастность

**Light mode**:
- Фон страницы: светлый (white или light gray)
- Фон карточки: белый
- Текст заголовков: темный (high contrast)
- Текст описаний: серый (medium contrast)
- Progress bar фон: светло-серый
- Progress bar заполнение: акцентный цвет (синий, зеленый)
- Кнопка: акцентный фон + белый текст

**Dark mode**:
- Фон страницы: темный (dark gray или black)
- Фон карточки: чуть светлее фона страницы
- Текст заголовков: светлый (high contrast)
- Текст описаний: приглушенный светлый
- Progress bar фон: темно-серый
- Progress bar заполнение: яркий акцентный цвет
- Кнопка: акцентный фон + контрастный текст

---

### 9. Анимации и микроинтеракции

**Hover на карточке**:
- Тень увеличивается (elevation)
- Duration: 200ms
- Easing: ease-out
- Transform: возможно легкий translateY вверх

**Hover на кнопке**:
- Фон: чуть темнее/светлее
- Duration: 150ms
- Cursor: pointer

**Click на кнопке**:
- Scale: немного уменьшается (0.98x)
- Duration: 100ms
- Мгновенная визуальная обратная связь

**Progress bar анимация**:
- При загрузке страницы: плавное заполнение от 0 до нужного процента
- Duration: 500ms
- Easing: ease-out

---

### 10. Пустые состояния (Edge cases)

**Нет доступных курсов**:
- Показать заглушку: "У вас пока нет доступных курсов"
- Возможно: призыв к действию (CTA) для получения доступа

**Все курсы завершены**:
- Показать поздравление: "Вы завершили все доступные курсы!"
- Кнопка "Начать курс" может меняться на "Пройти снова" или "Обзор"

**Загрузка данных**:
- Показать скелетоны (skeleton loaders) на месте карточек
- Количество скелетонов: 2-4 штуки
- Структура скелетона повторяет структуру карточки

---

### 11. Ключевые принципы UX

1. **Ясность цели**: Пользователь сразу видит доступные курсы и может начать обучение
2. **Прогресс виден**: Каждая карточка показывает текущий прогресс
3. **Простота действия**: Одна кнопка "Начать курс" - понятное действие
4. **Продолжение с места остановки**: Если есть прогресс, пользователь переходит на незавершенную страницу
5. **Визуальная иерархия**: Название → Описание → Прогресс → Действие
6. **Обратная связь**: Все взаимодействия дают визуальный feedback
7. **Адаптивность**: Работает на всех размерах экранов

---

### 12. Чеклист для воспроизведения UX

- [ ] Создать страницу со списком курсов
- [ ] Добавить заголовок и подзаголовок
- [ ] Создать сетку карточек (responsive: 2-3 cols desktop, 1 col mobile)
- [ ] В каждой карточке:
  - [ ] Название курса (h3, bold)
  - [ ] Описание курса (paragraph, muted)
  - [ ] Блок прогресса с текстом "X/Y глав"
  - [ ] Горизонтальный progress bar
  - [ ] Кнопка "Начать курс" (full width, primary style)
- [ ] Реализовать hover эффекты (тень на карточке, затемнение кнопки)
- [ ] Реализовать click эффект (scale на кнопке)
- [ ] При клике на "Начать курс":
  - [ ] Найти первую незавершенную страницу (если есть прогресс)
  - [ ] Или первую страницу курса (если прогресса нет)
  - [ ] Перейти на эту страницу
- [ ] Адаптировать для mobile (1 колонка, touch-friendly)
- [ ] Поддержка light/dark mode
- [ ] Добавить состояние загрузки (skeleton loaders)
- [ ] Добавить пустое состояние (нет курсов)

---

## Страница курса (UI/UX)

Этот раздел описывает UI/UX логику страницы прохождения курса - как пользователь читает контент, отслеживает прогресс и завершает страницы. Описание без технических деталей для воспроизведения в любом проекте.

### Общая структура страницы

**URL**: `/[locale]/courses/[courseSlug]/[chapterIdx]/[pageSlug]`
**Пример**: `/ru/courses/intro-to-panarchy/1/welcome`

**Layout**:
```
┌─────────────────────────────────────────────┐
│          Header (навигация)                 │
├────────────────┬────────────────────────────┤
│                │                            │
│   Sidebar      │     Main Content           │
│   (Навигация)  │     (Markdown текст)       │
│                │                            │
│   • Название   │  # Заголовок страницы      │
│     курса      │                            │
│   • Прогресс   │  Текст страницы курса...   │
│                │                            │
│   Главы:       │  ## Подзаголовок           │
│   ☐ Page 1     │                            │
│   ☑ Page 2     │  Еще текст...              │
│   ● Page 3     │                            │
│   ☐ Page 4     │  ─────────────────────     │
│                │  [Завершить страницу →]    │
│                │                            │
└────────────────┴────────────────────────────┘
```

---

### 1. Sidebar (навигационная панель)

#### A. Позиционирование и поведение

**Desktop (широкие экраны)**:
- Sidebar зафиксирован слева
- Ширина: фиксированная (примерно 300-320px)
- Всегда видим
- Занимает полную высоту экрана
- Scrollable если содержимое не помещается

**Mobile (узкие экраны)**:
- Sidebar скрыт по умолчанию
- Открывается кнопкой "Menu" в header
- Появляется слева с анимацией slide-in
- Overlay (затемнение) на остальной части экрана
- Закрывается:
  - При клике на overlay
  - При клике на страницу
  - При свайпе влево

#### B. Структура Sidebar

**Верхняя секция - Информация о курсе**:
```
┌─────────────────────────────┐
│ Introduction to Panarchy    │ ← Название курса (h2)
│                             │
│ Главы             0%        │ ← Label + процент
│ ███░░░░░░░░░░░░░░░          │ ← Progress bar
│ 0 из 3 завершено            │ ← Числовой прогресс
└─────────────────────────────┘
```

**Элементы**:
1. **Название курса**:
   - Размер: средний-крупный
   - Стиль: font-medium
   - Позиция: вверху sidebar

2. **Текст "Главы" + процент**:
   - Layout: flex, space-between
   - Левая часть: "Главы" (label)
   - Правая часть: "0%" или "33%" (процент)
   - Размер: маленький текст
   - Цвет: приглушенный

3. **Progress Bar курса**:
   - Высота: тонкая (6-8px)
   - Ширина: полная
   - Фон: светло-серый
   - Заполнение: акцентный цвет
   - Скругление: небольшое

4. **Числовой прогресс**:
   - Текст: "X из Y завершено"
   - Размер: маленький
   - Цвет: приглушенный

**Отступы**:
- Padding вокруг верхней секции: средний
- Border снизу: тонкая линия разделения

---

#### C. Список глав и страниц

**Структура одной главы**:
```
┌─────────────────────────────┐
│ Welcome to Panarchy      0% │ ← Заголовок главы + %
│ ████░░░░░░░░░░░░░░░░░░      │ ← Progress bar главы
│                             │
│ ☐ Welcome                   │ ← Страницы
│ ☐ Introduction              │
│ ☐ Why Panarchy Matters      │
└─────────────────────────────┘
```

**Элементы главы**:

1. **Заголовок главы**:
   - Текст: название главы (h3)
   - Справа: процент завершения (0%, 33%, 100%)
   - Layout: flex, space-between
   - Размер: medium
   - Цвет: основной текст

2. **Progress bar главы**:
   - Высота: тонкая (4-6px)
   - Показывает процент завершенных страниц в главе
   - Формула: `(завершенные страницы / всего страниц) * 100`

3. **Список страниц**:
   - Каждая страница = кнопка
   - Отступ слева: небольшой (для визуальной иерархии)
   - Вертикальный gap между страницами: малый

---

#### D. Визуальные индикаторы состояния страниц

Каждая страница имеет **квадратный чекбокс-индикатор** слева от названия:

**1. Не начатая страница** (пустой чекбокс):
```
┌──┐ Introduction
└──┘
```
- Индикатор: квадрат с тонкой серой границей
- Внутри: пусто
- Фон кнопки: прозрачный
- Текст: обычный цвет
- Cursor: pointer

**2. Текущая страница** (активная):
```
┌──┐ Introduction     ← оранжевый фон
│ ●│                  ← квадрат заполнен + точка
└──┘
```
- Индикатор: квадрат заполнен акцентным цветом (оранжевый)
- Внутри квадрата: маленькая точка контрастного цвета
- Фон кнопки: акцентный цвет с прозрачностью (orange/10)
- Border кнопки: акцентная граница (orange/20)
- Текст: акцентный цвет, font-medium
- Cursor: pointer

**3. Завершенная страница** (с галочкой):
```
┌──┐ Welcome
│✓ │
└──┘
```
- Индикатор: квадрат заполнен акцентным цветом
- Внутри: галочка (checkmark) белого/контрастного цвета
- Фон кнопки: легкий акцентный оттенок (primary/5)
- Текст: обычный цвет
- Cursor: pointer

**Размеры индикаторов**:
- Ширина/высота квадрата: 16px × 16px
- Border width: 2px
- Галочка внутри: ~10px × 10px
- Скругление углов: нет (sharp corners для квадрата)

---

#### E. Визуальное выделение активной главы

Глава, содержащая текущую страницу, выделяется:
- **Border**: оранжевая/акцентная граница вокруг блока главы
- **Background**: легкий акцентный фон (optional)
- **Эффект**: визуально показывает в какой главе сейчас пользователь

Пример:
```
┌─────────────────────────────┐ ← серая граница
│ Welcome to Panarchy      0% │
│ ...                         │
└─────────────────────────────┘

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓ ← ОРАНЖЕВАЯ граница
┃ Core Concepts           0%  ┃
┃ ████░░░░░░░░░░░░░░░░░       ┃
┃ ☐ Adaptive Cycles           ┃
┃ ● Scale and Hierarchy       ┃ ← текущая
┃ ☐ Types of Resilience       ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

┌─────────────────────────────┐ ← серая граница
│ Practical Applications   0% │
│ ...                         │
└─────────────────────────────┘
```

---

### 2. Main Content (основной контент)

#### A. Структура контента

```
┌──────────────────────────────────┐
│                                  │
│  # Заголовок страницы (h1)       │ ← Markdown content
│                                  │
│  Текст страницы...               │
│                                  │
│  ## Подзаголовок (h2)            │
│                                  │
│  Еще текст, списки, таблицы...   │
│                                  │
│  ────────────────────────────    │ ← Разделитель
│                                  │
│  [📍 Завершить страницу    →]    │ ← Кнопка действия
│                                  │
└──────────────────────────────────┘
```

**Основные элементы**:

1. **Markdown контент**:
   - Render как HTML с типографикой (prose styles)
   - Максимальная ширина: ~800px (для читаемости)
   - Padding: средний со всех сторон
   - Centered на широких экранах

2. **Типографика**:
   - Заголовки: крупные, с margin снизу
   - Параграфы: line-height 1.6-1.8 (для читаемости)
   - Списки: с отступами и bullet points
   - Код: моноширинный шрифт, фон отличается
   - Ссылки: подчеркнуты, акцентный цвет

3. **Разделитель** (border-top):
   - Перед кнопкой завершения
   - Тонкая горизонтальная линия
   - Padding-top: большой
   - Margin-top: большой

---

#### B. Кнопка "Завершить страницу"

**Позиция**: внизу контента, после разделителя

**Визуальное представление**:
```
┌──────────────────────────────────┐
│  ✓  Завершить страницу      →   │
└──────────────────────────────────┘
```

**Элементы кнопки**:
- **Иконка слева**: CheckCircle (галочка в круге)
- **Текст**: "Завершить страницу"
- **Иконка справа**: ArrowRight (стрелка вправо)
  - Показывается только если это НЕ последняя страница
  - Подсказывает, что будет переход дальше

**Стили**:
- Размер: большая кнопка (min-height 44px)
- Ширина: full-width на mobile, auto на desktop
- Фон: акцентный цвет (primary)
- Текст: контрастный (обычно белый)
- Border-radius: среднее скругление
- Padding: средний

**Состояния кнопки**:

1. **Default (не нажата)**:
   - Фон: primary
   - Cursor: pointer
   - Hover: фон чуть темнее

2. **Loading (во время обработки)**:
   - Текст: "Завершается..." или спиннер
   - Disabled: нельзя нажать повторно
   - Opacity: чуть меньше
   - Cursor: not-allowed

3. **После завершения** (страница уже completed):
   - Кнопка исчезает
   - Появляется сообщение о завершении (см. ниже)

---

#### C. Сообщение о завершении страницы

После нажатия кнопки "Завершить страницу" и перезагрузки (если пользователь вернулся):

```
┌──────────────────────────────────┐
│          ✓ Страница завершена    │ ← Центрированный текст
└──────────────────────────────────┘
```

**Визуальное оформление**:
- Фон: легкий акцентный цвет (primary/5)
- Border: акцентная граница (primary/20)
- Padding: средний-большой
- Текст: центрирован
- Иконка: галочка (✓)
- Цвет текста: акцентный или зеленый (success)

**Особый случай - последняя страница курса**:
```
┌──────────────────────────────────┐
│          ✓ Страница завершена    │
│                                  │
│      🎉 Курс завершен!           │ ← Дополнительное сообщение
└──────────────────────────────────┘
```

---

### 3. UX Флоу завершения страницы

#### Шаг 1: Пользователь читает контент
- Scroll контента вниз
- Видит кнопку "Завершить страницу"

#### Шаг 2: Клик на "Завершить страницу"
- Кнопка меняет состояние на Loading
- Отправляется запрос на сервер
- В sidebar индикатор страницы остается "текущая" (точка)

#### Шаг 3: Сервер обрабатывает запрос
1. Помечает страницу как completed в базе данных
2. Проверяет: все ли страницы в главе завершены?
3. **Если ДА** - глава помечается как DONE:
   - Статус главы: NEW → DONE
   - Следующая глава: статус → CURRENT
   - Progress bars обновляются
4. **Если НЕТ** - глава остается в статусе CURRENT

#### Шаг 4: Автоматическая навигация

**Сценарий A: Есть следующая страница в этой главе**
- Автоматический редирект на следующую страницу
- URL меняется: `/courses/X/1/page-2` → `/courses/X/1/page-3`
- Smooth scroll вверх
- Sidebar обновляется:
  - Предыдущая страница: точка (●) → галочка (✓)
  - Новая текущая: пустой (☐) → точка (●)

**Сценарий B: Это последняя страница главы, но есть следующая глава**
- Автоматический редирект на первую страницу следующей главы
- URL: `/courses/X/1/page-3` → `/courses/X/2/page-1`
- Sidebar обновляется:
  - Завершенная глава: border убирается, progress 100%
  - Новая глава: оранжевый border, первая страница активна

**Сценарий C: Это последняя страница курса**
- Редиректа НЕТ
- Остаемся на текущей странице
- Показывается сообщение "🎉 Курс завершен!"
- В sidebar:
  - Все страницы с галочками (✓)
  - Все главы: progress 100%
  - Общий прогресс курса: 100%

#### Шаг 5: Обновление UI после навигации
- Sidebar обновляет все индикаторы
- Progress bars анимированно заполняются
- Контент новой страницы загружается
- Scroll плавно поднимается вверх

---

### 4. Прогресс-трекинг (визуализация прогресса)

#### A. Три уровня прогресса

**1. Прогресс курса (верх sidebar)**:
```
Главы                    33%
████████░░░░░░░░░░░░░░
1 из 3 завершено
```
- Формула: `(завершенные главы / всего глав) * 100`
- Обновляется: когда завершается ВСЯ глава целиком

**2. Прогресс главы (в каждом блоке главы)**:
```
Core Concepts           25%
██████░░░░░░░░░░░░░
```
- Формула: `(завершенные страницы главы / всего страниц главы) * 100`
- Обновляется: после завершения каждой страницы

**3. Прогресс страницы (индикатор)**:
- ☐ Не начата (0%)
- ● Текущая (в процессе)
- ✓ Завершена (100%)

#### B. Логика статусов глав

Глава может иметь 3 статуса (но визуально не всегда отличаются):

**NEW (не начата)**:
- Все страницы: ☐ (пустые чекбоксы)
- Progress bar: 0%
- Border: обычный (серый)

**CURRENT (в процессе)**:
- Хотя бы одна страница: ● (текущая) или ✓ (завершена)
- Есть незавершенные страницы
- Progress bar: 1-99%
- Border: **оранжевый** (активная глава)

**DONE (завершена)**:
- Все страницы: ✓ (галочки)
- Progress bar: 100%
- Border: обычный (серый)
- Возможно: зеленый акцент на progress bar или тексте

---

### 5. Responsive поведение

#### Desktop (lg+):
- Layout: Sidebar (fixed, 300px) + Content (flex-1)
- Sidebar: всегда виден
- Content: max-width ~800px, centered
- Hover эффекты: активны

#### Tablet (md):
- Похоже на desktop
- Content ширина: адаптируется
- Sidebar: может быть чуть уже

#### Mobile (< lg):
- Sidebar: скрыт по умолчанию
- Mobile header появляется:
  - Кнопка Menu (hamburger icon)
  - Название текущей страницы
- Клик на Menu → sidebar slide-in слева
- Overlay (backdrop) затемняет контент
- Content: full width, padding по бокам

**Mobile header структура**:
```
┌─────────────────────────────────┐
│ ☰ Menu    |    Introduction     │
└─────────────────────────────────┘
```
- Слева: иконка меню (3 линии)
- Справа: название текущей страницы
- Height: ~56px (touch-friendly)

---

### 6. Анимации и микроинтеракции

#### A. Smooth scroll при смене страницы
- При навигации на новую страницу: автоматический scroll вверх
- Behavior: smooth (плавная прокрутка)
- Delay: ~100ms (чтобы контент успел отрендериться)

#### B. Sidebar slide-in (mobile)
- Открытие: translateX(-100%) → translateX(0)
- Закрытие: translateX(0) → translateX(-100%)
- Duration: 200ms
- Easing: ease-in-out
- Backdrop: fade in/out (opacity 0 → 0.5)

#### C. Progress bar заполнение
- При обновлении процента: плавная анимация
- Duration: 300-500ms
- Easing: ease-out
- Визуально "растет" от текущего значения к новому

#### D. Индикатор страницы переход
- Пустой (☐) → Текущая (●): мгновенно при клике
- Текущая (●) → Завершенная (✓): transition 200ms
- Фон кнопки: transition 150ms

#### E. Кнопка "Завершить страницу"
- Hover: фон чуть темнее, transition 150ms
- Click: scale(0.98), transition 100ms
- Loading: fade opacity, spinner rotation

---

### 7. Цветовая схема

#### Light mode:
- Sidebar фон: белый или очень светлый серый
- Content фон: белый
- Текст: темный (high contrast)
- Border: светло-серый
- Активная глава border: оранжевый
- Progress bar filled: оранжевый/синий
- Progress bar unfilled: светло-серый

#### Dark mode:
- Sidebar фон: темный (dark gray)
- Content фон: чуть светлее темного
- Текст: светлый (high contrast)
- Border: темно-серый
- Активная глава border: яркий оранжевый
- Progress bar filled: яркий оранжевый/синий
- Progress bar unfilled: темно-серый

---

### 8. Keyboard navigation и accessibility

**Tab navigation**:
- Tab между страницами в sidebar
- Tab до кнопки "Завершить страницу"
- Enter/Space: активировать выбранный элемент

**Screen readers**:
- Aria-labels на индикаторах: "Not started", "Current page", "Completed"
- Progress bars: aria-valuenow, aria-valuemin, aria-valuemax
- Кнопки: описательный text

**Focus indicators**:
- Visible outline на focused элементах
- Цвет: акцентный или высококонтрастный

---

### 9. Edge cases и особые состояния

**Загрузка страницы**:
- Skeleton loader на месте контента
- Sidebar: показывается сразу с данными

**Ошибка завершения страницы**:
- Toast notification: "Failed to complete page"
- Кнопка возвращается в normal state
- Пользователь может попробовать снова

**Потеря интернет-соединения**:
- Кнопка "Завершить страницу": показывает ошибку
- Offline indicator (optional)

**Уже завершенная страница**:
- Кнопка "Завершить страницу" НЕ показывается
- Вместо нее: сообщение "✓ Страница завершена"
- Пользователь может свободно навигировать к другим страницам

---

### 10. Ключевые UX принципы

1. **Ясность прогресса**: Пользователь всегда видит где он находится и сколько осталось
2. **Автоматическая навигация**: После завершения страницы - автопереход на следующую
3. **Визуальная обратная связь**: Все действия дают мгновенный визуальный feedback
4. **Минимум кликов**: Один клик для завершения → автоматический переход
5. **Не потеряться**: Активная глава и страница всегда выделены
6. **Мотивация**: Progress bars заполняются - визуально приятно
7. **Гибкость**: Можно свободно переходить между страницами в любом порядке

---

### 11. Чеклист для воспроизведения UX

#### Sidebar Navigation:
- [ ] Создать sidebar с фиксированной позицией (desktop)
- [ ] Добавить responsive поведение (mobile: slide-in)
- [ ] Секция с названием курса и общим прогрессом вверху
- [ ] Progress bar курса (% завершенных глав)
- [ ] Список глав в виде блоков
- [ ] Каждая глава:
  - [ ] Заголовок + процент завершения
  - [ ] Progress bar главы
  - [ ] Список страниц под главой
- [ ] Индикаторы состояния страниц:
  - [ ] Пустой квадрат (☐) - не начата
  - [ ] Квадрат с точкой (●) - текущая, оранжевый фон
  - [ ] Квадрат с галочкой (✓) - завершена
- [ ] Выделение активной главы оранжевой границей
- [ ] Клик на страницу → навигация

#### Main Content:
- [ ] Markdown рендеринг с типографикой (prose styles)
- [ ] Максимальная ширина ~800px для читаемости
- [ ] Centered на широких экранах
- [ ] Разделитель перед кнопкой
- [ ] Кнопка "Завершить страницу":
  - [ ] Иконка галочки слева
  - [ ] Текст "Завершить страницу"
  - [ ] Иконка стрелки справа (если не последняя страница)
  - [ ] Full-width на mobile
  - [ ] Loading state при обработке
- [ ] Сообщение о завершении (если уже completed):
  - [ ] "✓ Страница завершена"
  - [ ] Если последняя в курсе: "🎉 Курс завершен!"

#### Логика завершения:
- [ ] При клике "Завершить страницу":
  - [ ] Отправить запрос на сервер
  - [ ] Пометить страницу как completed
  - [ ] Проверить: все ли страницы главы завершены?
  - [ ] Если да - пометить главу DONE, следующую CURRENT
  - [ ] Обновить все progress bars
  - [ ] Автоматически перейти на следующую незавершенную страницу
  - [ ] Если это последняя страница курса - остаться на месте
- [ ] После навигации:
  - [ ] Обновить индикаторы в sidebar
  - [ ] Smooth scroll вверх
  - [ ] Обновить состояние кнопки

#### Progress tracking:
- [ ] Вычислять прогресс курса: завершенные главы / всего глав
- [ ] Вычислять прогресс главы: завершенные страницы / всего страниц
- [ ] Анимировать progress bars при обновлении
- [ ] Показывать числовые значения (X из Y)

#### Responsive:
- [ ] Desktop: sidebar fixed + content centered
- [ ] Mobile: sidebar hidden, открывается по клику
- [ ] Mobile header с кнопкой Menu
- [ ] Backdrop overlay при открытом sidebar
- [ ] Slide-in анимация sidebar

#### Animations:
- [ ] Smooth scroll при смене страницы
- [ ] Sidebar slide-in/out (200ms)
- [ ] Progress bar fill animation (300-500ms)
- [ ] Button hover/click effects
- [ ] Backdrop fade in/out

---

## Архитектура страницы курса

### Компонентная иерархия

```
page.tsx (Server Component)
  └─ CourseLayout (Client Component)
      ├─ CourseNavigation (Client, Sidebar)
      │   ├─ Course header с прогрессом
      │   └─ Список глав и страниц
      └─ CourseContent (Client, Main content)
          ├─ MarkdownRenderer
          └─ CompletePageButton
```

### 1. CourseLayout (`components/course-layout.tsx`)

**Роль**: Главный layout-компонент, управляющий расположением sidebar и контента.

**Ключевые особенности**:

```typescript
interface CourseLayoutProps {
  course: CourseWithChapters         // Полная структура курса
  currentChapter: Chapter            // Текущая глава
  currentPage: Page                  // Текущая страница
  userProgress: ProgressMap          // Прогресс по главам
  pageProgress: PageProgressMap      // Прогресс по страницам
}
```

**Функциональность**:

1. **Responsive Sidebar**:
   - Desktop (lg+): Статичный sidebar слева
   - Mobile: Выдвижной sidebar с backdrop
   - Состояние `sidebarOpen` контролирует видимость

```typescript
const [sidebarOpen, setSidebarOpen] = useState(false)

// Mobile backdrop для закрытия
{sidebarOpen && (
  <div
    className="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden"
    onClick={() => setSidebarOpen(false)}
  />
)}
```

2. **Smooth Scroll при смене страницы**:
   - useEffect срабатывает при изменении `currentPage.id`
   - Плавная прокрутка вверх с задержкой 100ms для рендера

```typescript
useEffect(() => {
  const smoothScrollToTop = () => {
    window.scrollTo({ top: 0, behavior: 'smooth' })
  }
  const timeoutId = setTimeout(smoothScrollToTop, 100)
  return () => clearTimeout(timeoutId)
}, [currentPage.id])
```

3. **Mobile Header**:
   - Отображается только на `lg:hidden`
   - Кнопка Menu для открытия sidebar
   - Название текущей страницы

---

### 2. CourseNavigation (`components/course-navigation.tsx`)

**Роль**: Боковая панель навигации с визуализацией прогресса и списком глав/страниц.

**Ключевые функции**:

#### A. Course Header с общим прогрессом

```typescript
const courseProgress = Math.round(
  (course.completedChapters / course.totalChapters) * 100
)

// Gradient header
<div className="p-6 border-b bg-gradient-to-r from-background to-muted/20">
  <h2>{course.title}</h2>
  <Progress value={courseProgress} className="h-2" />
  <div>{course.completedChapters} of {course.totalChapters} completed</div>
</div>
```

#### B. Список глав с прогрессом

Каждая глава отображается с:
- **Заголовком главы**
- **Progress bar** (процент завершенных страниц в главе)
- **Списком страниц**

```typescript
const getChapterProgress = (chapter) => {
  const totalPages = chapter.pages.length
  const completedPages = chapter.pages.filter(
    page => pageProgress[page.id]
  ).length
  const percentage = totalPages > 0
    ? Math.round((completedPages / totalPages) * 100)
    : 0
  return { completed: completedPages, total: totalPages, percentage }
}
```

#### C. Страницы с визуальными индикаторами

Каждая страница имеет 3 состояния:

1. **Завершенная** (`isCompleted = true`):
   - Квадратный чекбокс с галочкой ✓
   - Фон `bg-primary/5`
   - Текст: обычный

2. **Текущая** (`isCurrent = true`):
   - Квадратный чекбокс с точкой внутри
   - Фон `bg-primary/10`, border `border-primary/20`
   - Текст: `font-medium text-primary`

3. **Новая** (не начата):
   - Пустой квадратный border
   - Цвет border: `border-muted-foreground/30`

```typescript
// Визуальный индикатор статуса страницы
<div className={cn(
  "flex-shrink-0 w-4 h-4 border-2 transition-all duration-200",
  isCompleted
    ? "bg-primary border-primary"    // Зеленый заполненный
    : isCurrent
      ? "bg-primary border-primary"  // Синий заполненный
      : "border-muted-foreground/30" // Пустой серый
)}>
  {isCompleted && (
    <svg className="w-2 h-2 text-white" fill="currentColor">
      {/* Checkmark SVG */}
    </svg>
  )}
  {isCurrent && !isCompleted && (
    <div className="w-1.5 h-1.5 bg-background"></div>
  )}
</div>
```

#### D. Навигация между страницами

```typescript
const handlePageClick = (chapterIndex: number, pageSlug: string) => {
  // Программная навигация с локалью
  router.push(`/${locale}/courses/${course.slug}/${chapterIndex}/${pageSlug}`)
  // Закрыть sidebar на мобильных
  onNavigate?.()
}
```

**Важно**: Используется `getLocaleFromPathname(pathname)` вместо `useLocale()` для правильной работы после перезагрузки страницы.

---

### 3. CourseContent (`components/course-content.tsx`)

**Роль**: Основной контент страницы - markdown и кнопка завершения.

**Структура**:

```typescript
<div className="h-full flex flex-col">
  <ScrollArea className="flex-1">
    <div className="p-6 max-w-4xl mx-auto">
      {/* Markdown контент */}
      <div className="prose prose-lg max-w-none dark:prose-invert">
        <MarkdownRenderer content={currentPage.markdown} />
      </div>

      {/* Кнопка завершения (если не завершена) */}
      {!isPageCompleted && (
        <div className="mt-8 pt-8 border-t">
          <CompletePageButton
            courseSlug={course.slug}
            pageId={currentPage.id}
            isLastPageInCourse={isLastPageInCourse}
          />
        </div>
      )}

      {/* Сообщение о завершении */}
      {isPageCompleted && (
        <div className="mt-8 pt-8 border-t">
          <div className="text-center p-6 bg-primary/5 border border-primary/20">
            ✓ {t('pageCompleted')}
            {isLastPageInCourse && (
              <div className="text-lg font-semibold">
                {t('courseCompleted')}
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  </ScrollArea>
</div>
```

**Логика определения последней страницы**:

```typescript
const isLastPageInCourse =
  currentChapter.index === course.chapters.length &&  // Последняя глава
  currentPage.index === currentChapter.pages.length   // Последняя страница
```

---

### 4. CompletePageButton (`components/complete-page-button.tsx`)

**Роль**: Кнопка для завершения страницы с автоматическим переходом на следующую.

**Ключевые особенности**:

#### A. Server Action вызов

```typescript
const handleComplete = async () => {
  setIsCompleting(true)

  try {
    // Server Action из lib/progress.ts
    await completePage(courseSlug, pageId)

    // Toast показывается только если НЕ произошел redirect
    toast.success(
      isLastPageInCourse ? t('courseCompleted') : t('pageCompleted')
    )
  } catch (error) {
    // ВАЖНО: Next.js redirect выбрасывает специальную ошибку
    if (error?.digest?.startsWith('NEXT_REDIRECT')) {
      // Это нормальный redirect - не показываем ошибку
      return
    }

    // Только реальные ошибки
    console.error('Error completing page:', error)
    toast.error('Failed to complete page')
  } finally {
    setIsCompleting(false)
  }
}
```

#### B. Состояния кнопки

1. **Не завершена** (основное состояние):
```typescript
<Button onClick={handleComplete} disabled={isCompleting}>
  <CheckCircle className="h-4 w-4 mr-2" />
  {isCompleting ? t('completing') : t('completePage')}
  {!isLastPageInCourse && <ArrowRight className="h-4 w-4 ml-2" />}
</Button>
```

2. **Завершена**:
```typescript
<div className="flex items-center gap-2 text-green-600">
  <CheckCircle className="h-5 w-5" />
  <span className="font-medium">{t('pageCompleted')}</span>
</div>
```

#### C. Автоматическая навигация

Server Action `completePage` в `lib/progress.ts`:

1. Помечает страницу как завершенную
2. Проверяет, завершены ли все страницы в главе
3. Если да - помечает главу как DONE, следующую как CURRENT
4. **Автоматически делает redirect** на следующую страницу/главу
5. Инвалидирует кеш через `revalidateTag`

```typescript
// В lib/progress.ts
if (nextPageInChapter) {
  // Редирект на следующую страницу в той же главе
  redirect(`/${locale}/courses/${courseSlug}/${currentChapter.index}/${nextPageInChapter.slug}`)
} else if (nextChapter && nextChapter.pages.length > 0) {
  // Редирект на первую страницу следующей главы
  redirect(`/${locale}/courses/${courseSlug}/${nextChapter.index}/${nextChapter.pages[0].slug}`)
}
// Иначе - остаемся на текущей странице (курс завершен)
```

---

## Система навигации

### Маршрутизация

**Структура URL**:
```
/[locale]/courses                             # Список курсов
/[locale]/courses/[courseSlug]                # Обзор курса (не используется)
/[locale]/courses/[courseSlug]/[chapterIdx]/[pageSlug]  # Страница курса
```

**Пример**: `/ru/courses/intro-to-panarchy/1/welcome`

### Программная навигация

```typescript
import { useRouter, usePathname } from 'next/navigation'
import { getLocaleFromPathname } from '@/lib/utils'

const router = useRouter()
const pathname = usePathname()
const locale = getLocaleFromPathname(pathname)

// Навигация с сохранением локали
router.push(`/${locale}/courses/${courseSlug}/${chapterIdx}/${pageSlug}`)
```

### Хелпер функция getLocaleFromPathname

```typescript
// lib/utils.ts
export function getLocaleFromPathname(pathname: string): string {
  const segments = pathname.split('/').filter(Boolean)
  const firstSegment = segments[0]

  if (firstSegment === 'en' || firstSegment === 'ru') {
    return firstSegment
  }

  return 'ru' // Дефолтная локаль
}
```

**Почему не `useLocale()` из next-intl?**
- `useLocale()` не работает корректно после перезагрузки страницы в Client Components
- `getLocaleFromPathname` парсит URL напрямую - работает всегда

### API endpoints для навигации

#### `/api/courses/[courseSlug]/first-page`

Находит первую страницу курса:
```typescript
const firstChapter = course.chapters[0]
const firstPage = firstChapter.pages[0]
return { url: `/${locale}/courses/${courseSlug}/${firstChapter.index}/${firstPage.slug}` }
```

#### `/api/courses/[courseSlug]/next-page`

Находит первую НЕзавершенную страницу:
```typescript
// Перебирает главы и страницы
for (const chapter of course.chapters) {
  for (const page of chapter.pages) {
    const pageProgress = await prisma.pageProgress.findUnique({
      where: { userId_pageId: { userId, pageId: page.id } }
    })

    if (!pageProgress || !pageProgress.completed) {
      // Первая незавершенная страница
      return { url: `/${locale}/courses/${courseSlug}/${chapter.index}/${page.slug}` }
    }
  }
}
```

### Использование в CourseCard

```typescript
const handleStartCourse = async () => {
  // 1. Пробуем найти первую незавершенную страницу
  const response = await fetch(`/api/courses/${course.slug}/next-page`)
  if (response.ok && data.url) {
    router.push(data.url)
    return
  }

  // 2. Fallback - первая страница курса
  const fallbackResponse = await fetch(`/api/courses/${course.slug}/first-page`)
  if (fallbackResponse.ok && fallbackData.url) {
    router.push(fallbackData.url)
    return
  }

  // 3. Ultimate fallback - жестко закодированная первая страница
  router.push(`/${locale}/courses/${course.slug}/1/welcome`)
}
```

---

## Система прогресса

### Модели данных

#### ProgressMap (прогресс глав)
```typescript
type ProgressMap = Record<string, 'NEW' | 'CURRENT' | 'DONE'>

// Пример:
{
  "chapter-id-1": "DONE",      // Завершена
  "chapter-id-2": "CURRENT",   // В процессе
  "chapter-id-3": "NEW"        // Новая
}
```

#### PageProgressMap (прогресс страниц)
```typescript
type PageProgressMap = Record<string, boolean>

// Пример:
{
  "page-id-1": true,    // Завершена
  "page-id-2": true,    // Завершена
  "page-id-3": false    // Не завершена
}
```

### Вычисление прогресса

#### Прогресс курса

```typescript
const courseProgress = Math.round(
  (course.completedChapters / course.totalChapters) * 100
)
```

Где `completedChapters` - количество глав со статусом `DONE`.

#### Прогресс главы

```typescript
const getChapterProgress = (chapter) => {
  const totalPages = chapter.pages.length
  const completedPages = chapter.pages.filter(
    page => pageProgress[page.id] === true
  ).length
  const percentage = Math.round((completedPages / totalPages) * 100)

  return { completed: completedPages, total: totalPages, percentage }
}
```

### Визуализация прогресса

#### Progress Bar компонент (shadcn/ui)

```typescript
<Progress
  value={percentage}           // 0-100
  className="h-2 transition-all duration-300 ease-out"
/>
```

**CSS анимация** (от Tailwind):
- `transition-all` - плавный переход всех свойств
- `duration-300` - 300ms
- `ease-out` - замедление в конце

#### Цвета индикаторов

```typescript
const getProgressTextColor = (percentage: number) => {
  if (percentage === 0) return 'text-muted-foreground'  // Серый
  if (percentage === 100) return 'text-primary'         // Зеленый/акцент
  return 'text-primary'                                 // Синий/акцент
}
```

### Server Action для обновления прогресса

```typescript
// lib/progress.ts - Server Action
'use server'

export async function completePage(courseSlug: string, pageId: string) {
  const session = await getSession()

  // 1. Помечаем страницу как завершенную
  await prisma.pageProgress.upsert({
    where: { userId_pageId: { userId: session.userId, pageId } },
    update: { completed: true, completedAt: new Date() },
    create: { userId: session.userId, pageId, completed: true, completedAt: new Date() }
  })

  // 2. Проверяем, завершены ли все страницы в главе
  const currentPage = await prisma.page.findUnique({
    where: { id: pageId },
    include: { chapter: { include: { pages: true, course: { include: { chapters: { include: { pages: true } } } } } } }
  })

  const chapterPageIds = currentPage.chapter.pages.map(p => p.id)
  const completedPagesInChapter = await prisma.pageProgress.count({
    where: { userId: session.userId, pageId: { in: chapterPageIds }, completed: true }
  })

  // 3. Если все страницы завершены - помечаем главу как DONE
  if (completedPagesInChapter === chapterPageIds.length) {
    await prisma.progress.upsert({
      where: { userId_chapterId: { userId: session.userId, chapterId: currentPage.chapterId } },
      update: { status: 'DONE' },
      create: { userId: session.userId, chapterId: currentPage.chapterId, status: 'DONE' }
    })

    // 4. Помечаем следующую главу как CURRENT
    const nextChapter = currentPage.chapter.course.chapters.find(
      ch => ch.index > currentPage.chapter.index
    )

    if (nextChapter) {
      await prisma.progress.upsert({
        where: { userId_chapterId: { userId: session.userId, chapterId: nextChapter.id } },
        update: { status: 'CURRENT' },
        create: { userId: session.userId, chapterId: nextChapter.id, status: 'CURRENT' }
      })
    }
  }

  // 5. Инвалидируем кеш
  revalidateTag('user-progress')
  revalidateTag('course')

  // 6. Редирект на следующую страницу
  const nextPage = findNextPage(currentPage)
  if (nextPage) {
    redirect(nextPage.url)
  }
}
```

---

## Обработка Markdown

### Pipeline обработки

**Библиотеки**: unified + remark + rehype

```typescript
// lib/markdown.ts
export async function processMarkdown(markdown: string): Promise<string> {
  // 1. Препроцессинг: IPFS изображения
  const processedMarkdown = processIpfsImages(markdown)

  // 2. unified pipeline
  const result = await unified()
    .use(remarkParse)              // Парсинг Markdown -> MDAST
    .use(remarkGfm)                // GitHub Flavored Markdown (таблицы, чеклисты)
    .use(remarkRehype, {
      allowDangerousHtml: true     // Разрешить HTML в Markdown
    })
    .use(rehypeRaw)                // Парсить HTML внутри Markdown
    .use(rehypeSlug)               // Добавить id к заголовкам
    .use(rehypeAutolinkHeadings)   // Автоссылки на заголовки
    .use(rehypeExternalLinks)      // Кастомный плагин для внешних ссылок
    .use(rehypeStringify)          // HAST -> HTML string
    .process(processedMarkdown)

  return result.toString()
}
```

### Поддержка IPFS изображений

**Синтаксис**: `![[ipfs://QmHash/path/image.png]]`

**Обработка**:
```typescript
function processIpfsImages(markdown: string): string {
  const ipfsPattern = /!\[\[ipfs:\/\/([^[\]]+)\]\]/g

  return markdown.replace(ipfsPattern, (match, hashAndPath) => {
    const ipfsGateway = process.env.NEXT_PUBLIC_IPFS_GATEWAY || 'ipfs.io'
    const gatewayUrl = `https://${ipfsGateway}/ipfs/${hashAndPath}`

    // Extract filename for alt text
    const fileName = hashAndPath.split('/').pop() || 'IPFS Image'
    const altText = fileName.replace(/\.[^.]+$/, '')

    // Standard markdown: ![altText](url)
    return `![${altText}](${gatewayUrl})`
  })
}
```

**Пример**:
```markdown
![[ipfs://QmYwAPJzv5CZsnA625s3Xf2nemtYgPpHdWEz79ojWnPbdG/image.png]]
```
↓
```markdown
![image](https://ipfs.io/ipfs/QmYwAPJzv5CZsnA625s3Xf2nemtYgPpHdWEz79ojWnPbdG/image.png)
```

### Автоматические якоря для заголовков

**rehypeSlug** добавляет `id` к заголовкам:

```markdown
## What is Panarchy?
```
↓
```html
<h2 id="what-is-panarchy">What is Panarchy?</h2>
```

**rehypeAutolinkHeadings** добавляет ссылки:
```html
<h2 id="what-is-panarchy">
  <a href="#what-is-panarchy" aria-hidden="true">
    <span class="icon icon-link"></span>
  </a>
  What is Panarchy?
</h2>
```

### Внешние ссылки (target="_blank")

**Кастомный плагин** `rehypeExternalLinks()`:

```typescript
function rehypeExternalLinks() {
  return function (tree: any) {
    function walk(node: any) {
      if (node.type === 'element' && node.tagName === 'a') {
        const href = String(node.properties.href)

        if (isExternalLink(href)) {
          node.properties.target = '_blank'
          node.properties.rel = 'noopener noreferrer'
        }
      }

      if (node.children) {
        for (const child of node.children) {
          walk(child)
        }
      }
    }

    walk(tree)
  }
}

function isExternalLink(href: string): boolean {
  // Относительные ссылки - внутренние
  if (!href.startsWith('http://') && !href.startsWith('https://')) {
    return false
  }

  const url = new URL(href)
  const currentDomain = process.env.NEXT_PUBLIC_DOMAIN || 'localhost:3000'

  return url.hostname !== currentDomain && url.hostname !== 'localhost'
}
```

### Client-side рендеринг

**MarkdownRenderer** компонент (`components/markdown-renderer.tsx`):

```typescript
'use client'

// In-memory кеш для обработанного markdown
const markdownCache = new Map<string, string>()

export function MarkdownRenderer({ content }: { content: string }) {
  const [html, setHtml] = useState<string>('')
  const [loading, setLoading] = useState(true)

  // Cache key на основе контента
  const cacheKey = useMemo(() => {
    return content.length > 100
      ? content.slice(0, 100) + '...' + content.length
      : content
  }, [content])

  useEffect(() => {
    const renderMarkdown = async () => {
      // Проверяем кеш
      if (markdownCache.has(cacheKey)) {
        setHtml(markdownCache.get(cacheKey)!)
        setLoading(false)
        return
      }

      // Обрабатываем markdown
      const processed = await processMarkdown(content)

      // Кешируем результат
      markdownCache.set(cacheKey, processed)
      setHtml(processed)
      setLoading(false)
    }

    renderMarkdown()
  }, [content, cacheKey])

  if (loading) {
    return <LoadingSpinner />
  }

  return (
    <div
      className="prose prose-lg max-w-none dark:prose-invert"
      dangerouslySetInnerHTML={{ __html: html }}
    />
  )
}
```

**Ключевые оптимизации**:
1. **In-memory кеш** - обработанный HTML сохраняется в Map
2. **useMemo для cache key** - пересчитывается только при изменении контента
3. **Loading state** - показываем спиннер во время обработки

### Prose стили (Tailwind Typography)

```typescript
className="prose prose-lg max-w-none dark:prose-invert"
```

- `prose` - базовые типографские стили
- `prose-lg` - крупный шрифт
- `max-w-none` - без ограничения ширины
- `dark:prose-invert` - инверсия цветов в темной теме

**Стилизация элементов**:
- `<h1>` - крупные заголовки с margin
- `<h2>, <h3>` - меньшие заголовки
- `<p>` - параграфы с line-height
- `<a>` - подчеркнутые ссылки
- `<blockquote>` - цитаты с border-left
- `<code>` - inline код
- `<pre><code>` - блоки кода
- `<ul>, <ol>` - списки
- `<table>` - таблицы

---

## Интернационализация

### next-intl конфигурация

**Middleware** (`middleware.ts`):
```typescript
import createMiddleware from 'next-intl/middleware'

export default createMiddleware({
  locales: ['en', 'ru'],
  defaultLocale: 'ru'
})

export const config = {
  matcher: ['/((?!api|_next|_vercel|.*\\..*).*)']  // Все кроме API и статики
}
```

### Файлы переводов

**Структура**:
```
messages/
  ├── en.json    # Английский
  └── ru.json    # Русский (default)
```

**Пример** (`messages/ru.json`):
```json
{
  "common": {
    "appName": "Oghma",
    "connectWallet": "Подключить Stellar кошелёк",
    "logout": "Выйти"
  },
  "courses": {
    "title": "Доступные курсы",
    "progress": "Прогресс",
    "startCourse": "Начать курс"
  },
  "course": {
    "completePage": "Завершить страницу",
    "pageCompleted": "Страница завершена",
    "chapters": "Главы"
  }
}
```

### Использование в компонентах

#### Server Components

```typescript
import { getTranslations } from 'next-intl/server'

export default async function Page({ params }: { params: Promise<{ locale: string }> }) {
  const { locale } = await params
  const t = await getTranslations({ locale, namespace: 'courses' })

  return <h1>{t('title')}</h1>
}
```

#### Client Components

```typescript
'use client'

import { useTranslations } from 'next-intl'

export function Component() {
  const t = useTranslations('course')

  return <button>{t('completePage')}</button>
}
```

### Переключение языка

**Header компонент** (`components/header.tsx`):

```typescript
const switchLocale = (newLocale: string) => {
  // Парсим текущий pathname
  const segments = pathname.split('/').filter(Boolean)
  const currentLocale = segments[0]

  // Заменяем локаль в URL
  if (currentLocale === 'en' || currentLocale === 'ru') {
    segments[0] = newLocale
  } else {
    segments.unshift(newLocale)
  }

  const newPath = '/' + segments.join('/')

  // Полная перезагрузка страницы для корректной смены локали
  window.location.href = newPath
}
```

**UI**:
```typescript
<DropdownMenu>
  <DropdownMenuTrigger asChild>
    <Button variant="ghost" size="icon">
      <Globe className="h-[1.2rem] w-[1.2rem]" />
    </Button>
  </DropdownMenuTrigger>
  <DropdownMenuContent>
    <DropdownMenuItem onClick={() => switchLocale('en')}>
      English
    </DropdownMenuItem>
    <DropdownMenuItem onClick={() => switchLocale('ru')}>
      Русский
    </DropdownMenuItem>
  </DropdownMenuContent>
</DropdownMenu>
```

**Важно**:
- `window.location.href` используется для **полной перезагрузки** страницы
- Простой `router.push()` может не обновить все переводы корректно

---

## UI/UX паттерны

### Responsive дизайн

#### Breakpoints (Tailwind)

```typescript
// tailwind.config.ts
{
  screens: {
    'sm': '640px',   // Mobile landscape
    'md': '768px',   // Tablet
    'lg': '1024px',  // Desktop
    'xl': '1280px',  // Large desktop
    '2xl': '1536px'  // Extra large
  }
}
```

#### Mobile-First подход

```typescript
// Базовые стили для mobile, префиксы для desktop
<div className="
  p-4                // Mobile: padding 16px
  lg:p-6             // Desktop: padding 24px
  text-sm            // Mobile: small text
  lg:text-base       // Desktop: normal text
">
```

### Sidebar паттерн

#### Desktop (lg+)
```typescript
<div className="
  fixed inset-y-0 left-0
  w-80 bg-background border-r
  lg:translate-x-0 lg:static
">
  {/* Всегда видимый на desktop */}
</div>
```

#### Mobile
```typescript
<div className={cn(
  "fixed inset-y-0 left-0 z-50 w-80",
  "transform transition-transform duration-200",
  sidebarOpen ? "translate-x-0" : "-translate-x-full",
  "lg:translate-x-0"  // Override на desktop
)}>
  {/* Выдвигается при sidebarOpen = true */}
</div>

{/* Backdrop */}
{sidebarOpen && (
  <div
    className="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden"
    onClick={() => setSidebarOpen(false)}
  />
)}
```

### Touch targets (Accessibility)

**Минимальный размер**: 44px × 44px (Apple HIG, WCAG)

```typescript
<Button className="
  min-h-[44px]              // Минимум 44px высота
  px-3 py-2                 // Достаточный padding
  text-sm                   // Читаемый текст
  active:scale-[0.98]       // Визуальная обратная связь при нажатии
">
```

### Анимации

#### Transitions (Tailwind)

```typescript
className="
  transition-all           // Все свойства
  duration-200             // 200ms
  ease-out                 // Easing функция
  hover:shadow-md          // Hover эффект
  active:scale-[0.98]      // Active эффект
"
```

#### Примеры

**Progress bar анимация**:
```typescript
<Progress
  value={percentage}
  className="h-2 transition-all duration-500 ease-out"
/>
```

**Sidebar slide-in**:
```typescript
className={cn(
  "transform transition-transform duration-200 ease-in-out",
  sidebarOpen ? "translate-x-0" : "-translate-x-full"
)}
```

**Button scale на click**:
```typescript
className="active:scale-[0.98] transition-transform duration-100"
```

### Loading states

#### Spinner

```typescript
{loading && (
  <div className="flex items-center justify-center py-8">
    <div className="
      animate-spin rounded-full
      h-8 w-8 border-b-2 border-primary
    "></div>
  </div>
)}
```

#### Button disabled state

```typescript
<Button
  onClick={handleComplete}
  disabled={isCompleting}
  className="disabled:opacity-50 disabled:cursor-not-allowed"
>
  {isCompleting ? 'Completing...' : 'Complete Page'}
</Button>
```

### Цветовая схема

#### shadcn/ui переменные

```css
/* globals.css */
:root {
  --background: 0 0% 100%;
  --foreground: 222.2 84% 4.9%;
  --primary: 221.2 83.2% 53.3%;
  --muted: 210 40% 96.1%;
  /* ... */
}

.dark {
  --background: 222.2 84% 4.9%;
  --foreground: 210 40% 98%;
  --primary: 217.2 91.2% 59.8%;
  /* ... */
}
```

#### Использование

```typescript
<div className="
  bg-background           // Фон
  text-foreground         // Основной текст
  bg-primary              // Акцентный цвет
  text-muted-foreground   // Приглушенный текст
  border border-primary/20 // Border с прозрачностью
">
```

### Theme switching

**next-themes** (`components/theme-provider.tsx`):

```typescript
'use client'

import { ThemeProvider as NextThemesProvider } from 'next-themes'

export function ThemeProvider({ children }: { children: React.ReactNode }) {
  return (
    <NextThemesProvider
      attribute="class"         // Использовать class для темы
      defaultTheme="system"     // Дефолт - системная тема
      enableSystem              // Поддержка system theme
    >
      {children}
    </NextThemesProvider>
  )
}
```

**Header theme toggle**:

```typescript
import { useTheme } from 'next-themes'

const { theme, setTheme } = useTheme()

<DropdownMenu>
  <DropdownMenuItem onClick={() => setTheme('light')}>
    Light
  </DropdownMenuItem>
  <DropdownMenuItem onClick={() => setTheme('dark')}>
    Dark
  </DropdownMenuItem>
  <DropdownMenuItem onClick={() => setTheme('system')}>
    System
  </DropdownMenuItem>
</DropdownMenu>
```

---

## Оптимизации производительности

### 1. Markdown кеширование

**In-memory кеш** в `MarkdownRenderer`:

```typescript
const markdownCache = new Map<string, string>()

// Cache key на основе первых 100 символов + длина
const cacheKey = content.length > 100
  ? content.slice(0, 100) + '...' + content.length
  : content

// Проверяем кеш перед обработкой
if (markdownCache.has(cacheKey)) {
  setHtml(markdownCache.get(cacheKey)!)
  return
}

// Обрабатываем и кешируем
const processed = await processMarkdown(content)
markdownCache.set(cacheKey, processed)
```

**Преимущества**:
- Мгновенный рендеринг при повторном посещении страницы
- Не требует сетевых запросов
- Живет в течение сессии браузера

### 2. Next.js unstable_cache для данных

**lib/course-data.ts**:

```typescript
import { unstable_cache } from 'next/cache'

export const getAccessibleCourses = unstable_cache(
  async (userId: string) => {
    return await prisma.course.findMany({ /* ... */ })
  },
  ['accessible-courses'],  // Cache key
  {
    revalidate: 60,         // Обновлять каждые 60 секунд
    tags: ['courses']       // Тег для инвалидации
  }
)
```

**Инвалидация кеша**:

```typescript
import { revalidateTag } from 'next/cache'

// В Server Action после обновления данных
await prisma.pageProgress.update({ /* ... */ })

revalidateTag('user-progress')
revalidateTag('course')
revalidateTag('courses')
```

### 3. Lazy loading изображений

Next.js `<Image>` компонент:

```typescript
import Image from 'next/image'

<Image
  src="/oghma.png"
  alt="Oghma Logo"
  width={32}
  height={32}
  loading="lazy"      // Lazy load по умолчанию
  placeholder="blur"   // Blur placeholder
/>
```

### 4. Code splitting

**Автоматический** code splitting по:
- Страницам (каждая страница = отдельный chunk)
- Client Components (dynamic imports)

**Manual dynamic imports**:

```typescript
import dynamic from 'next/dynamic'

const HeavyComponent = dynamic(() => import('./HeavyComponent'), {
  loading: () => <LoadingSpinner />,
  ssr: false  // Client-side only
})
```

### 5. Оптимизация рендеринга

#### useMemo для тяжелых вычислений

```typescript
const cacheKey = useMemo(() => {
  return content.length > 100
    ? content.slice(0, 100) + '...' + content.length
    : content
}, [content])
```

#### React.memo для компонентов

```typescript
export const CourseCard = React.memo(({ course }: CourseCardProps) => {
  // ...
})
```

### 6. Server Components по умолчанию

**Преимущества**:
- Zero JavaScript на клиенте для Server Components
- Быстрая начальная загрузка
- SEO-friendly

**Используем Client Components только когда нужно**:
- Интерактивность (onClick, onChange)
- React hooks (useState, useEffect)
- Browser APIs (localStorage, window)

---

## Воспроизведение функциональности

### Чеклист для создания аналогичной системы

#### 1. Базовая структура

- [ ] Установить Next.js 15 с App Router
- [ ] Настроить TypeScript
- [ ] Установить Tailwind CSS
- [ ] Установить shadcn/ui компоненты

#### 2. Интернационализация

- [ ] Установить next-intl
- [ ] Создать middleware для роутинга
- [ ] Создать файлы переводов (en.json, ru.json)
- [ ] Добавить переключатель языков в header

#### 3. Система курсов

**Database Schema**:
- [ ] User (с Stellar account ID)
- [ ] Course (slug, title, description)
- [ ] Chapter (index, title, courseId)
- [ ] Page (index, title, slug, markdown, chapterId)
- [ ] Progress (userId, chapterId, status: NEW/CURRENT/DONE)
- [ ] PageProgress (userId, pageId, completed, completedAt)
- [ ] CourseAccess (userId, courseId)

**API Routes**:
- [ ] `/api/courses/[courseSlug]/first-page` - первая страница
- [ ] `/api/courses/[courseSlug]/next-page` - следующая незавершенная

#### 4. Компоненты

**Layout & Navigation**:
- [ ] CourseLayout - главный layout с sidebar
- [ ] CourseNavigation - sidebar с главами/страницами
- [ ] CourseContent - основной контент
- [ ] CompletePageButton - кнопка завершения
- [ ] Header - навигационный header

**UI Components** (shadcn/ui):
- [ ] Button, Card, Progress, Badge
- [ ] DropdownMenu, ScrollArea
- [ ] Sonner (toast notifications)

#### 5. Markdown обработка

- [ ] Установить unified, remark, rehype
- [ ] Настроить pipeline обработки
- [ ] Добавить поддержку IPFS изображений
- [ ] Добавить автоматические якоря для заголовков
- [ ] Добавить target="_blank" для внешних ссылок
- [ ] Создать MarkdownRenderer с кешированием

#### 6. Система прогресса

- [ ] Server Action для завершения страницы
- [ ] Автоматическое обновление статуса главы
- [ ] Автоматическая навигация на следующую страницу
- [ ] Визуализация прогресса с Progress bars
- [ ] Индикаторы состояния страниц (чекбоксы)

#### 7. Responsive дизайн

- [ ] Mobile-first базовые стили
- [ ] Выдвижной sidebar для мобильных
- [ ] Touch-friendly кнопки (44px min)
- [ ] Backdrop для mobile menu

#### 8. Темная тема

- [ ] Установить next-themes
- [ ] Создать ThemeProvider
- [ ] Настроить CSS переменные для light/dark
- [ ] Добавить theme toggle в header

#### 9. Оптимизации

- [ ] Markdown кеширование в памяти
- [ ] Next.js unstable_cache для данных курсов
- [ ] Lazy loading изображений
- [ ] Code splitting (автоматический)
- [ ] useMemo для тяжелых вычислений

#### 10. Анимации и UX

- [ ] Smooth scroll при смене страницы
- [ ] Transition анимации для sidebar
- [ ] Progress bar анимации
- [ ] Button scale на active
- [ ] Loading states (spinners, disabled buttons)

---

## Ключевые файлы для референса

### Компоненты
- `components/course-layout.tsx` - главный layout
- `components/course-navigation.tsx` - sidebar навигация
- `components/course-content.tsx` - контент страницы
- `components/complete-page-button.tsx` - кнопка завершения
- `components/markdown-renderer.tsx` - рендеринг markdown
- `components/header.tsx` - header приложения
- `components/course-card.tsx` - карточка курса на главной

### Библиотеки
- `lib/course-data.ts` - функции получения данных курсов
- `lib/progress.ts` - Server Actions для прогресса
- `lib/markdown.ts` - обработка markdown
- `lib/utils.ts` - утилиты (cn, getLocaleFromPathname)

### Страницы
- `app/[locale]/courses/page.tsx` - список курсов
- `app/[locale]/courses/[courseSlug]/[chapterIdx]/[pageSlug]/page.tsx` - страница курса

### API
- `app/api/courses/[courseSlug]/first-page/route.ts`
- `app/api/courses/[courseSlug]/next-page/route.ts`

### Конфигурация
- `middleware.ts` - next-intl роутинг
- `tailwind.config.ts` - настройки Tailwind
- `messages/ru.json`, `messages/en.json` - переводы

---

## Заключение

Данная документация описывает полную архитектуру фронтенда курсовой платформы Oghma.

**Ключевые принципы архитектуры**:

1. **Модульность** - каждый компонент имеет четкую ответственность
2. **Переиспользуемость** - shadcn/ui компоненты, типизированные интерфейсы
3. **Performance** - кеширование, Server Components, оптимизированный markdown
4. **Accessibility** - семантический HTML, keyboard navigation, touch targets 44px
5. **Responsive** - mobile-first, адаптивный sidebar
6. **i18n** - полная поддержка многоязычности
7. **Progressive Enhancement** - работает без JavaScript (Server Components)

**Технологии выбраны для**:
- **Next.js 15** - Server Components, App Router, оптимизации
- **TypeScript** - type safety, лучший DX
- **Tailwind CSS** - быстрая разработка, consistency
- **shadcn/ui** - качественные accessible компоненты
- **unified** - мощная обработка markdown

Следуя этой документации и чеклисту, можно полностью воспроизвести функциональность платформы.
